(function(f,m){"object"===typeof exports&&"undefined"!==typeof module?module.exports=m():"function"===typeof define&&define.amd?define(m):f.tvunna=m()})(this,function(){function f(a){w&&window.console.log(a)}function m(){f("Connected");for(c.listenTopicOut&&l.subscribe(c.topicOut);0!=r.length;)x(r.shift())}function z(a){f("Connection Attempt to Host "+c.host+" Failed");setTimeout(d.MQTTconnect,1E3*c.reconnectTimeout)}function A(a){0!==a.errorCode&&f("onConnectionLost:"+a.errorMessage);d.MQTTconnect()}
function x(a){setTimeout(function(){var b=new Paho.MQTT.Message(a);b.destinationName=c.topicIn;b.qos=c.qos;l.send(b);f("Message sent to : "+c.host+":"+c.port+" : "+a)},0)}function n(a){a=JSON.stringify(a);l.isConnected()?x(a):r.push(a)}function s(){var a=4294967295*Math.random()|0,b=4294967295*Math.random()|0,d=4294967295*Math.random()|0,c=4294967295*Math.random()|0;return e[a&255]+e[a>>8&255]+e[a>>16&255]+e[a>>24&255]+"-"+e[b&255]+e[b>>8&255]+"-"+e[b>>16&15|64]+e[b>>24&255]+"-"+e[d&63|128]+e[d>>
8&255]+"-"+e[d>>16&255]+e[d>>24&255]+e[c&255]+e[c>>8&255]+e[c>>16&255]+e[c>>24&255]}function B(a){"interactive"===document.readyState||"complete"===document.readyState?a():document.addEventListener("DOMContentLoaded",a)}function g(a){return a&&0<a.length?a:null}function t(a){for(;a&&a!==document;a=a.parentNode)if(a.hasAttribute("data-section"))return a.getAttribute("data-section");return null}function u(a,b,d){document.addEventListener(a,function(a){var c;c=a.target;var e=c.matches||c.matchesSelector||
c.mozMatchesSelector||c.msMatchesSelector||c.oMatchesSelector||c.webkitMatchesSelector;e?c=e.apply(c,[b]):(f('log("Unable to match")'),c=!1);c&&d(a)})}function p(a,b){!1===c.cookies?(f("Visit tracking disabled"),h=k=null):(k||(k=d.getCookie("tvunna_visit")),h||(h=d.getCookie("tvunna_visitor")),k&&h?f("Active visit"):(!k&&c.cookiesGenerate&&(k=s(),d.setCookie("tvunna_visit",k,C)),d.getCookie("tvunna_visit")?(f("Visit started"),!h&&c.cookiesGenerate&&(h=s(),d.setCookie("tvunna_visitor",h,D))):f("Cookies disabled")));
return{app_id:c.app_id,event_id:s(),event_name:a,sent_tstamp:new Date,visit_id:k,visitor_id:h,schema_id:null,landing_page:window.location.href,title:g(document.title),referrer:g(document.referrer),user_agent:navigator.userAgent,href:null,tag:null,id:null,text:null,class_name:null,section:null,properties:b||{},mqtt_client_id:y}}var c={host:"tvunna.io",port:8443,useSSL:!0,timeout:3,reconnectTimeout:2,qos:0,topicIn:"tvunna/in",topicOut:"tvunna/out",listenTopicOut:!1,cookies:!0,cookiesGenerate:!1,app_id:"demo-js",
schema_id:"js0001",event_type:"js",event_type_custom:"js-api"},d=window.tvunna||window.Tvunna||{},l,r=[],k,h,C=30,D=1051200,y="js-"+(Math.random().toString(36)+"000000000000").substr(2,11),v={set:function(a,b,c,d){var e="",f="";c&&(e=new Date,e.setTime(e.getTime()+6E4*c),e="; expires="+e.toGMTString());d&&(f="; domain="+d);document.cookie=a+"="+escape(b)+e+f+"; SameSite=None; Secure; path=/"},get:function(a){var b,c=a+"=",d=document.cookie.split(";");for(a=0;a<d.length;a++){for(b=d[a];" "===b.charAt(0);)b=
b.substring(1,b.length);if(0===b.indexOf(c))return unescape(b.substring(c.length,b.length))}return null}};d.setCookie=function(a,b,d){v.set(a,b,d,c.cookieDomain||c.domain)};d.getCookie=function(a){return v.get(a)};d.destroyCookie=function(a){v.set(a,"",-1)};d.configure=function(a){for(var b in a)a.hasOwnProperty(b)&&(c[b]=a[b])};d.configure(d);var w=d.getCookie("tvunna_debug");d.MQTTconnect=function(){var a=y,b={useSSL:c.useSSL,timeout:c.timeout,onSuccess:m,onFailure:z};f("connecting to: "+c.host+
":"+c.port+", clientId: "+a);l=new Paho.MQTT.Client(c.host,c.port,a);c.listenTopicOut&&(l.onMessageArrived=onMessageArrived);l.onConnectionLost=A;l.connect(b)};for(var e=[],q=0;256>q;q++)e[q]=(16>q?"0":"")+q.toString(16);d.reset=function(){d.destroyCookie("tvunna_visit");d.destroyCookie("tvunna_visitor");return!0};d.debug=function(a){!1===a?d.destroyCookie("tvunna_debug"):d.setCookie("tvunna_debug","t",525600);w=d.getCookie("tvunna_debug");return!0};d.track=function(a,b,d){a=p(a,b);a.event_type=c.event_type_custom;
a.schema_id=d||c.schema_id;f("tvunna.track");n(a);return!0};d.trackView=function(){B(function(){var a=p("pageView");a.event_type=c.event_type;a.schema_id=c.schema_id;f("tvunna.trackView");n(a)})};d.trackClicks=function(){u("click","a, button, input[type=submit], img",function(a){a=a.target;var b=p("click");b.event_type=c.event_type;b.tag=g(a.tagName.toLowerCase());"img"==b.tag?(b.href=g(a.parentNode.href),b.properties=a.parentNode.dataset):(b.href=g(a.href),b.properties=a.dataset);b.id=g(a.id);b.text=
g("input"==b.tag?a.value:(a.textContent||a.innerText||a.innerHTML).replace(/[\s\r\n]+/g," ").trim());b.class_name=g(a.className);b.section=t(a);b.schema_id=a.getAttribute("data-schema_id")||c.schema_id;f("tvunna.trackClicks");n(b)})};d.trackSubmits=function(){u("submit","form",function(a){a=a.target;var b=p("submit");b.event_type=c.event_type;b.href=g(a.href);b.tag=g(a.tagName.toLowerCase());b.id=g(a.id);b.class_name=g(a.className);b.section=t(a);b.schema_id=a.getAttribute("data-schema_id")||c.schema_id;
f("tvunna.trackSubmits");n(b)})};d.trackChanges=function(){u("change","input, textarea, select",function(a){a=a.target;var b=p("change");b.event_type=c.event_type;b.href=g(a.href);b.tag=g(a.tagName.toLowerCase());b.id=g(a.id);b.text=g("input"==b.tag?a.value:(a.textContent||a.innerText||a.innerHTML).replace(/[\s\r\n]+/g," ").trim());b.class_name=g(a.className);b.section=t(a);b.schema_id=a.getAttribute("data-schema_id")||c.schema_id;f("tvunna.trackChanges");n(b)})};d.trackAll=function(){d.trackView();
d.trackClicks();d.trackSubmits();d.trackChanges()};return d});
